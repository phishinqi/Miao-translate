<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–µè¯­ç¿»è¯‘å™¨</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            border-bottom: 2px solid #ddd;
            transition: all 0.3s;
        }
        .tab.active {
            border-bottom: 2px solid #3498db;
            color: #3498db;
        }
        textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }
        .char-counter {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-bottom: 10px;
        }
        .char-counter.warning {
            color: #e67e22;
            font-weight: bold;
        }
        .char-counter.danger {
            color: #e74c3c;
            font-weight: bold;
        }
        .length-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        .result-container {
            position: relative;
        }
        .result-preview {
            max-height: 200px;
            overflow-y: auto;
            word-break: break-all;
            white-space: pre-wrap;
        }
        .result-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .result-stats {
            font-size: 12px;
            color: #666;
            flex-grow: 1;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        .copy-btn {
            background-color: #2ecc71;
            margin-left: 10px;
            padding: 8px 16px;
            font-size: 14px;
        }
        .copy-btn:hover {
            background-color: #27ae60;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 14px;
            color: #7f8c8d;
        }
        .debug-panel {
            margin-top: 30px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        #debug-btn {
            background-color: #e74c3c;
        }
        #debug-btn:hover {
            background-color: #c0392b;
        }


        /* é…ç½®å¯¹è¯æ¡†æ ·å¼ */
        .config-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .config-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .config-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .config-close:hover {
            color: #e74c3c;
        }
        .config-section {
            margin-bottom: 25px;
        }
        .config-section h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        .config-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            margin-bottom: 10px;
        }
        .config-textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }
        .config-buttons {
            text-align: right;
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .config-btn {
            padding: 10px 20px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .config-btn-primary {
            background-color: #3498db;
            color: white;
        }
        .config-btn-primary:hover {
            background-color: #2980b9;
        }
        .config-btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        .config-btn-secondary:hover {
            background-color: #7f8c8d;
        }
        .config-btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .config-btn-danger:hover {
            background-color: #c0392b;
        }
        .theme-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .theme-btn {
            background-color: #34495e;
            color: white;
            border: none;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .theme-btn:hover {
            opacity: 0.8;
        }
        .theme-btn.active {
            background-color: #e74c3c;
        }

        /* æ·±è‰²ä¸»é¢˜ä¸‹çš„ä¸»é¢˜é€‰æ‹©å™¨ */
        body.dark-theme .theme-selector {
            background-color: rgba(45, 45, 45, 0.9);
            border: 1px solid #555555;
        }

        /* æ·±è‰²ä¸»é¢˜ */
        body.dark-theme {
            background-color: #2c3e50;
            color: #e0e0e0;
        }
        body.dark-theme .container {
            background-color: #34495e;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        body.dark-theme h1 {
            color: #ffffff;
        }
        body.dark-theme .tab {
            border-bottom: 2px solid #555555;
            color: #cccccc;
            background-color: transparent;
        }
        body.dark-theme .tab:hover {
            background-color: #404040;
        }
        body.dark-theme .tab.active {
            border-bottom: 2px solid #4a9eff;
            color: #4a9eff;
            background-color: #333333;
        }
        body.dark-theme textarea {
            background-color: #1e1e1e;
            color: #e0e0e0;
            border: 1px solid #555555;
        }
        body.dark-theme textarea:focus {
            border-color: #4a9eff;
            outline: none;
        }
        body.dark-theme textarea::placeholder {
            color: #888888;
        }
        body.dark-theme button {
            background-color: #4a9eff;
            color: #ffffff;
        }
        body.dark-theme button:hover {
            background-color: #357abd;
        }
        body.dark-theme .result {
            background-color: #1e1e1e;
            border-left: 4px solid #4a9eff;
            color: #e0e0e0;
        }
        body.dark-theme .copy-btn {
            background-color: #28a745;
        }
        body.dark-theme .copy-btn:hover {
            background-color: #1e7e34;
        }
        body.dark-theme .footer {
            color: #888888;
        }
        body.dark-theme .debug-panel {
            border-top: 1px solid #555555;
        }
        body.dark-theme textarea {
            background-color: #2c3e50;
            color: #e0e0e0;
            border: 1px solid #555555;
        }
        body.dark-theme textarea:focus {
            border-color: #3498db;
            outline: none;
        }
        body.dark-theme textarea::placeholder {
            color: #888888;
        }
        body.dark-theme .result {
            background-color: #2c3e50;
            border-left: 4px solid #3498db;
        }


        /* æ·±è‰²ä¸»é¢˜ä¸‹çš„é…ç½®å¯¹è¯æ¡† */
        body.dark-theme .config-modal-content {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }
        body.dark-theme .config-section h4 {
            color: #ffffff;
            border-bottom: 2px solid #4a9eff;
        }
        body.dark-theme .config-input,
        body.dark-theme .config-textarea {
            background-color: #1e1e1e;
            color: #e0e0e0;
            border: 1px solid #555555;
        }
        body.dark-theme .config-input:focus,
        body.dark-theme .config-textarea:focus {
            border-color: #4a9eff;
            outline: none;
        }
        body.dark-theme .config-buttons {
            border-top: 1px solid #555555;
        }

        /* ç²‰è‰²ä¸»é¢˜ */
        body.pink-theme {
            background-color: #fdf2f8;
            color: #831843;
        }
        body.pink-theme .container {
            background-color: #fce7f3;
            box-shadow: 0 2px 10px rgba(219, 39, 119, 0.1);
        }
        body.pink-theme h1 {
            color: #be185d;
        }
        body.pink-theme .tab.active {
            border-bottom: 2px solid #ec4899;
            color: #ec4899;
        }
        body.pink-theme button {
            background-color: #ec4899;
        }
        body.pink-theme button:hover {
            background-color: #be185d;
        }
        body.pink-theme .result {
            background-color: #fdf2f8;
            border-left: 4px solid #ec4899;
        }

        /* ç»¿è‰²ä¸»é¢˜ */
        body.green-theme {
            background-color: #f0fdf4;
            color: #14532d;
        }
        body.green-theme .container {
            background-color: #dcfce7;
            box-shadow: 0 2px 10px rgba(34, 197, 94, 0.1);
        }
        body.green-theme h1 {
            color: #15803d;
        }
        body.green-theme .tab.active {
            border-bottom: 2px solid #22c55e;
            color: #22c55e;
        }
        body.green-theme button {
            background-color: #22c55e;
        }
        body.green-theme button:hover {
            background-color: #15803d;
        }
        body.green-theme .result {
            background-color: #f0fdf4;
            border-left: 4px solid #22c55e;
        }

        /* æ–°çš„è°ƒè¯•é¢æ¿æ ·å¼ */
        .debug-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .debug-controls button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .debug-controls button:hover {
            background-color: #2980b9;
        }
        .debug-controls button:active {
            background-color: #1f5f8b;
        }
        #clear-debug-btn {
            background-color: #e74c3c !important;
        }
        #clear-debug-btn:hover {
            background-color: #c0392b !important;
        }

        /* ä¸åŒä¸»é¢˜ä¸‹çš„è°ƒè¯•æŒ‰é’® */
        body.pink-theme .debug-controls button {
            background-color: #ec4899;
        }
        body.pink-theme .debug-controls button:hover {
            background-color: #db2777;
        }
        body.pink-theme .debug-controls button:active {
            background-color: #be185d;
        }

        body.green-theme .debug-controls button {
            background-color: #22c55e;
        }
        body.green-theme .debug-controls button:hover {
            background-color: #16a34a;
        }
        body.green-theme .debug-controls button:active {
            background-color: #15803d;
        }

        body.dark-theme .debug-controls button {
            background-color: #4a90e2;
        }
        body.dark-theme .debug-controls button:hover {
            background-color: #357abd;
        }
        body.dark-theme .debug-controls button:active {
            background-color: #2563eb;
        }
        /* è°ƒè¯•é¢æ¿åŸºç¡€æ ·å¼å’Œä¸»é¢˜é€‚é… */

        /* é»˜è®¤ä¸»é¢˜ */
        .debug-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .debug-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .debug-section pre {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 0;
            background-color: #ffffff;
            color: #333333;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 3px;
        }
        #mapping-test-status, #full-test-status {
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 16px;
        }
        .status-success {
            color: #27ae60;
        }
        .status-error {
            color: #e74c3c;
        }

        /* æ·±è‰²ä¸»é¢˜ */
        body.dark-theme .debug-section {
            background-color: #2c3e50;
            border: 1px solid #555555;
        }
        body.dark-theme .debug-section h4 {
            color: #ffffff;
        }
        body.dark-theme .debug-section pre {
            background-color: #1e1e1e;
            color: #e0e0e0;
            border: 1px solid #555555;
        }

        /* ç²‰è‰²ä¸»é¢˜ */
        body.pink-theme .debug-section {
            background-color: #fdf2f8;
            border: 1px solid #f9a8d4;
        }
        body.pink-theme .debug-section h4 {
            color: #be185d;
        }
        body.pink-theme .debug-section pre {
            background-color: #ffffff;
            color: #333333;
            border: 1px solid #f9a8d4;
        }

        /* ç»¿è‰²ä¸»é¢˜ */
        body.green-theme .debug-section {
            background-color: #f0fdf4;
            border: 1px solid #86efac;
        }
        body.green-theme .debug-section h4 {
            color: #15803d;
        }
        body.green-theme .debug-section pre {
            background-color: #ffffff;
            color: #333333;
            border: 1px solid #86efac;
        }
    </style>
</head>
<body>
    <div class="theme-selector">
        <button class="theme-btn active" data-theme="default">é»˜è®¤</button>
        <button class="theme-btn" data-theme="dark">æ·±è‰²</button>
        <button class="theme-btn" data-theme="pink">ç²‰è‰²</button>
        <button class="theme-btn" data-theme="green">ç»¿è‰²</button>
        <button class="theme-btn" id="config-btn-header" style="background-color: #f39c12;">âš™ï¸</button>
        <button class="theme-btn" id="clear-cache-btn" style="background-color: #e74c3c;" title="æ¸…é™¤æ˜ å°„ç¼“å­˜">ğŸ—‘ï¸</button>
    </div>

    <div class="container">
        <h1>å–µè¯­ç¿»è¯‘å™¨</h1>

        <div class="tabs">
            <div class="tab active" id="encrypt-tab">åŠ å¯†</div>
            <div class="tab" id="decrypt-tab">è§£å¯†</div>
        </div>
        
        <div id="encrypt-panel">
            <textarea id="encrypt-input" placeholder="è¯·è¾“å…¥è¦åŠ å¯†çš„æ–‡æœ¬..." maxlength="5000"></textarea>
            <div class="char-counter" id="encrypt-counter">0 / 5000 å­—ç¬¦</div>
            <div class="length-warning" id="encrypt-warning">
                âš ï¸ æ–‡æœ¬è¾ƒé•¿ï¼ŒåŠ å¯†åçš„ç»“æœå¯èƒ½å¾ˆå¤§ï¼Œå»ºè®®åˆ†æ®µå¤„ç†æˆ–ä½¿ç”¨è¾ƒçŸ­çš„æ–‡æœ¬ã€‚
            </div>
            <button id="encrypt-btn">åŠ å¯†</button>

            <div class="result result-container" id="encrypt-result" style="display: none;">
                <h3>åŠ å¯†ç»“æœï¼š</h3>
                <div class="result-preview" id="encrypt-output"></div>
                <div class="result-actions">
                    <div class="result-stats" id="encrypt-stats"></div>
                    <button id="copy-encrypt" class="copy-btn">å¤åˆ¶ç»“æœ</button>
                    <button id="download-encrypt" class="copy-btn" style="background-color: #9b59b6;">ä¸‹è½½æ–‡ä»¶</button>
                </div>
            </div>
        </div>

        <div id="decrypt-panel" style="display: none;">
            <textarea id="decrypt-input" placeholder="è¯·è¾“å…¥è¦è§£å¯†çš„æ–‡æœ¬..."></textarea>
            <div class="char-counter" id="decrypt-counter">0 å­—ç¬¦</div>
            <div class="length-warning" id="decrypt-warning">
                âš ï¸ è¾“å…¥æ–‡æœ¬è¾ƒé•¿ï¼Œè§£å¯†å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚
            </div>
            <button id="decrypt-btn">è§£å¯†</button>

            <div class="result result-container" id="decrypt-result" style="display: none;">
                <h3>è§£å¯†ç»“æœï¼š</h3>
                <div class="result-preview" id="decrypt-output"></div>
                <div class="result-actions">
                    <div class="result-stats" id="decrypt-stats"></div>
                    <button id="copy-decrypt" class="copy-btn">å¤åˆ¶ç»“æœ</button>
                    <button id="download-decrypt" class="copy-btn" style="background-color: #9b59b6;">ä¸‹è½½æ–‡ä»¶</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>å–µè¯­ç¿»è¯‘å™¨ &copy; 2025</p>
    </div>

    <!-- é…ç½®å¯¹è¯æ¡† -->
    <div id="config-modal" class="config-modal">
        <div class="config-modal-content">
            <span class="config-close">&times;</span>
            <h2>é…ç½®å‚æ•°</h2>

            <div class="config-section">
                <h4>åŠ å¯†å‚æ•°</h4>
                <label>ç‰ˆæœ¬å· (VERSION):</label>
                <input type="text" id="config-version" class="config-input" placeholder="ä¾‹å¦‚: MiaoV0721">

                <label>å¯†é’¥ (KEY):</label>
                <input type="text" id="config-key" class="config-input" placeholder="ä¾‹å¦‚: 2hY8u5Pq3zRv7xW4jN0c1fT9eD6aXsB0">

                <label>ç›å€¼ (SALT):</label>
                <input type="text" id="config-salt" class="config-input" placeholder="ä¾‹å¦‚: K7mLp2oQ9nRz8sV4tC1uJ6yF3dH5gXbE">
            </div>

            <div class="config-section">
                <h4>å–µè¯­è¯æ±‡</h4>
                <label>å–µè¯­çŸ­è¯­ (æ¯è¡Œä¸€ä¸ª):</label>
                <textarea id="config-phrases" class="config-textarea" placeholder="å–µ&#10;å–µå–µ&#10;å–µ~&#10;å–µå‘œ&#10;å–µå—·&#10;å–µå–µå–µ"></textarea>
            </div>

            <div class="config-section">
                <h4>æ ‡ç‚¹ç¬¦å·</h4>
                <label>æ ‡ç‚¹ç¬¦å· (æ¯è¡Œä¸€ä¸ª):</label>
                <textarea id="config-punctuations" class="config-textarea" placeholder="ï¼Œ&#10;ã€‚&#10;ï¼&#10;ï¼Ÿ&#10;~&#10;..."></textarea>
            </div>

            <div class="config-buttons">
                <button class="config-btn config-btn-danger" id="config-reset">é‡ç½®ä¸ºé»˜è®¤</button>
                <button class="config-btn config-btn-secondary" id="config-cancel">å–æ¶ˆ</button>
                <button class="config-btn config-btn-primary" id="config-save">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <script>
        // é›¶å®½å­—ç¬¦é›†
        const ZERO_WIDTH_CHARS = [
            '\u200b',
            '\u200c',
            '\u200d',
            '\u2060',
            '\u200e',
            '\u200f',
            '\ufeff',
        ];

        // é»˜è®¤é…ç½®
        const DEFAULT_CONFIG = {
            VERSION: "MiaoV0721",
            KEY: "2hY8u5Pq3zRv7xW4jN0c1fT9eD6aXsB0",
            SALT: "K7mLp2oQ9nRz8sV4tC1uJ6yF3dH5gXbE",
            PHRASES: ["å–µ", "å–µå–µ", "å–µ~", "å–µå‘œ", "å–µå—·", "å–µå–µå–µ"],
            PUNCTUATIONS: ["ï¼Œ", "ã€‚", "ï¼", "ï¼Ÿ", "~", "..."],
            MAX_INPUT_LENGTH: 5000,  // æœ€å¤§è¾“å…¥é•¿åº¦
            CHUNK_SIZE: 1000,        // åˆ†å—å¤„ç†å¤§å°
            WARNING_LENGTH: 100,     // é™ä½è­¦å‘Šé•¿åº¦é˜ˆå€¼
            ULTRA_COMPACT_MODE: false // ç¦ç”¨è¶…ç´§å‡‘æ¨¡å¼ï¼Œç»Ÿä¸€ä½¿ç”¨æ ‡å‡†æ¨¡å¼
        };

        // å½“å‰é…ç½®ï¼ˆå¯ä»¥è¢«ç”¨æˆ·ä¿®æ”¹ï¼‰
        let CONFIG = { ...DEFAULT_CONFIG };

        // ä¸ºäº†å‘åå…¼å®¹ï¼Œä¿ç•™åŸæœ‰çš„å˜é‡å
        let KEY = CONFIG.KEY;
        let SALT = CONFIG.SALT;
        let VERSION = CONFIG.VERSION;
        let PHRASES = [...CONFIG.PHRASES];
        let PUNCTUATIONS = [...CONFIG.PUNCTUATIONS];

        // é…ç½®ç®¡ç†å‡½æ•°
        function loadConfig() {
            console.log('å¼€å§‹åŠ è½½é…ç½®...');
            const savedConfig = localStorage.getItem('miao-config');
            console.log('ä»localStorageè¯»å–çš„é…ç½®:', savedConfig);
            if (savedConfig) {
                try {
                    const parsed = JSON.parse(savedConfig);
                    console.log('è§£æåçš„é…ç½®:', parsed);
                    CONFIG = { ...DEFAULT_CONFIG, ...parsed };
                    console.log('åˆå¹¶åçš„CONFIG:', CONFIG);
                    updateVariables();
                } catch (e) {
                    console.warn('é…ç½®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', e);
                }
            } else {
                console.log('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
            }
        }

        function saveConfig() {
            localStorage.setItem('miao-config', JSON.stringify(CONFIG));
            updateVariables();
        }

        function updateVariables() {
            KEY = CONFIG.KEY;
            SALT = CONFIG.SALT;
            VERSION = CONFIG.VERSION;
            PHRASES = [...CONFIG.PHRASES];
            PUNCTUATIONS = [...CONFIG.PUNCTUATIONS];
            console.log('é…ç½®å·²æ›´æ–°:', { KEY, SALT, VERSION, PHRASES, PUNCTUATIONS });
        }

        function resetConfig() {
            CONFIG = { ...DEFAULT_CONFIG };
            updateVariables();
            updateConfigUI();
        }

        function updateConfigUI() {
            document.getElementById('config-version').value = CONFIG.VERSION;
            document.getElementById('config-key').value = CONFIG.KEY;
            document.getElementById('config-salt').value = CONFIG.SALT;
            document.getElementById('config-phrases').value = CONFIG.PHRASES.join('\n');
            document.getElementById('config-punctuations').value = CONFIG.PUNCTUATIONS.join('\n');
        }

        function getConfigFromUI() {
            const phrases = document.getElementById('config-phrases').value
                .split('\n')
                .map(p => p.trim())
                .filter(p => p.length > 0);

            const punctuations = document.getElementById('config-punctuations').value
                .split('\n')
                .map(p => p.trim())
                .filter(p => p.length > 0);

            return {
                VERSION: document.getElementById('config-version').value.trim() || DEFAULT_CONFIG.VERSION,
                KEY: document.getElementById('config-key').value.trim() || DEFAULT_CONFIG.KEY,
                SALT: document.getElementById('config-salt').value.trim() || DEFAULT_CONFIG.SALT,
                PHRASES: phrases.length > 0 ? phrases : DEFAULT_CONFIG.PHRASES,
                PUNCTUATIONS: punctuations.length > 0 ? punctuations : DEFAULT_CONFIG.PUNCTUATIONS
            };
        }

        // å…¨å±€æ˜ å°„è¡¨ç¼“å­˜ï¼Œç¡®ä¿åŠ å¯†å’Œè§£å¯†ä½¿ç”¨ç›¸åŒçš„æ˜ å°„
        let GLOBAL_MAPPING_CACHE = null;

        // æ¸…é™¤æ˜ å°„ç¼“å­˜çš„å‡½æ•°ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        function clearMappingCache() {
            GLOBAL_MAPPING_CACHE = null;
            console.log('æ˜ å°„ç¼“å­˜å·²æ¸…é™¤');
        }

        // æµ‹è¯•æ˜ å°„æ­£ç¡®æ€§çš„å‡½æ•°
        function testMapping() {
            console.log('=== å¼€å§‹æ˜ å°„æµ‹è¯• ===');

            // åˆ›å»ºæ˜ å°„
            const mapping = createBase64ToZeroWidthMap();

            // åˆ›å»ºåå‘æ˜ å°„
            const reverseMapping = {};
            for (const [key, value] of Object.entries(mapping)) {
                reverseMapping[value] = key;
            }

            console.log(`æ­£å‘æ˜ å°„æ•°é‡: ${Object.keys(mapping).length}`);
            console.log(`åå‘æ˜ å°„æ•°é‡: ${Object.keys(reverseMapping).length}`);

            // æµ‹è¯•å‰10ä¸ªå­—ç¬¦çš„å¾€è¿”è½¬æ¢
            const testChars = "ABCDEFGHIJabcdefghij";
            let allPassed = true;

            for (let i = 0; i < testChars.length; i++) {
                const char = testChars[i];
                const zwCombo = mapping[char];
                const backToChar = reverseMapping[zwCombo];

                const passed = char === backToChar;
                if (!passed) allPassed = false;

                const comboDebug = Array.from(zwCombo).map(c => '\\u' + c.charCodeAt(0).toString(16).padStart(4, '0')).join('');
                console.log(`æµ‹è¯• "${char}": ${char} -> ${comboDebug} -> "${backToChar}" ${passed ? 'âœ“' : 'âœ—'}`);
            }

            console.log(`=== æ˜ å°„æµ‹è¯•ç»“æœ: ${allPassed ? 'å…¨éƒ¨é€šè¿‡' : 'å­˜åœ¨é—®é¢˜'} ===`);
            return allPassed;
        }

        // æµ‹è¯•å®Œæ•´åŠ å¯†è§£å¯†æµç¨‹çš„å‡½æ•°
        function testFullEncryptDecrypt() {
            console.log('=== å¼€å§‹å®Œæ•´åŠ å¯†è§£å¯†æµ‹è¯• ===');

            const testMessage = "æµ‹è¯•";
            console.log(`æµ‹è¯•æ¶ˆæ¯: "${testMessage}"`);

            try {
                // åŠ å¯†
                const encrypted = encryptMessage(testMessage);
                console.log(`åŠ å¯†ç»“æœé•¿åº¦: ${encrypted.length}`);

                // æå–é›¶å®½å­—ç¬¦
                const zeroWidthCharsRegex = new RegExp(`[${ZERO_WIDTH_CHARS.join('')}]`, 'g');
                const encryptedZwChars = encrypted.match(zeroWidthCharsRegex) || [];
                console.log(`åŠ å¯†æ—¶ç”Ÿæˆçš„é›¶å®½å­—ç¬¦æ•°é‡: ${encryptedZwChars.length}`);
                console.log(`å‰9ä¸ªåŠ å¯†é›¶å®½å­—ç¬¦:`);
                for (let i = 0; i < Math.min(9, encryptedZwChars.length); i++) {
                    const char = encryptedZwChars[i];
                    const code = char.charCodeAt(0).toString(16).padStart(4, '0');
                    console.log(`  [${i}] \\u${code}`);
                }

                // è§£å¯†
                const decrypted = decryptMessage(encrypted);
                console.log(`è§£å¯†ç»“æœ: "${decrypted}"`);

                const success = testMessage === decrypted;
                console.log(`=== å®Œæ•´æµ‹è¯•ç»“æœ: ${success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'} ===`);
                return success;
            } catch (e) {
                console.error(`æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™: ${e.message}`);
                return false;
            }
        }

        // ä½¿ç”¨3ä¸ªé›¶å®½å­—ç¬¦ç»„åˆçš„Base64æ˜ å°„ï¼Œç¡®ä¿è¶³å¤Ÿçš„å”¯ä¸€ç»„åˆ
        function createBase64ToZeroWidthMap() {
            // å¦‚æœå·²æœ‰ç¼“å­˜ï¼Œç›´æ¥è¿”å›
            if (GLOBAL_MAPPING_CACHE) {
                console.log(`ä½¿ç”¨ç¼“å­˜çš„æ˜ å°„è¡¨: ${Object.keys(GLOBAL_MAPPING_CACHE).length} ä¸ªæ˜ å°„`);
                return GLOBAL_MAPPING_CACHE;
            }

            const base64Chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
            const mapping = {};

            // ä½¿ç”¨3ä¸ªé›¶å®½å­—ç¬¦çš„ç»„åˆï¼š7^3 = 343 ç§ç»„åˆï¼Œè¿œè¶…65ä¸ªBase64å­—ç¬¦çš„éœ€æ±‚
            const zwChars = ZERO_WIDTH_CHARS;
            const totalCombinations = zwChars.length * zwChars.length * zwChars.length;

            console.log(`åˆ›å»ºæ–°æ˜ å°„: ${base64Chars.length} ä¸ªBase64å­—ç¬¦, ${zwChars.length} ä¸ªé›¶å®½å­—ç¬¦, ${totalCombinations} ç§å¯èƒ½ç»„åˆ`);
            console.log(`é›¶å®½å­—ç¬¦åˆ—è¡¨:`, zwChars.map((c, i) => `[${i}] \\u${c.charCodeAt(0).toString(16).padStart(4, '0')}`));

            for (let i = 0; i < base64Chars.length; i++) {
                const char = base64Chars[i];

                // ä½¿ç”¨æ›´å‡åŒ€çš„ä¸‰ä½æ•°ç³»ç»Ÿåˆ†é…é›¶å®½å­—ç¬¦ç»„åˆ
                // ç¡®ä¿æ¯ä¸ªä½ç½®éƒ½èƒ½å……åˆ†åˆ©ç”¨
                const firstIndex = i % zwChars.length;
                const secondIndex = Math.floor(i / zwChars.length) % zwChars.length;
                const thirdIndex = Math.floor(i / (zwChars.length * zwChars.length)) % zwChars.length;

                const zeroWidthCombo = zwChars[firstIndex] + zwChars[secondIndex] + zwChars[thirdIndex];
                mapping[char] = zeroWidthCombo;

                if (i < 15) {
                    const comboDebug = Array.from(zeroWidthCombo).map(c => '\\u' + c.charCodeAt(0).toString(16).padStart(4, '0')).join('');
                    console.log(`[${i}] "${char}" -> [${firstIndex},${secondIndex},${thirdIndex}] -> ${comboDebug}`);
                }
            }

            // éªŒè¯æ˜ å°„çš„å”¯ä¸€æ€§
            const reverseMapping = {};
            let conflicts = 0;

            for (const [char, combo] of Object.entries(mapping)) {
                if (reverseMapping[combo]) {
                    conflicts++;
                    console.error(`æ˜ å°„å†²çª: "${char}" å’Œ "${reverseMapping[combo]}" éƒ½æ˜ å°„åˆ°ç›¸åŒç»„åˆ`);
                } else {
                    reverseMapping[combo] = char;
                }
            }

            if (conflicts > 0) {
                throw new Error(`æ˜ å°„è¡¨å­˜åœ¨ ${conflicts} ä¸ªå†²çª`);
            }

            console.log(`æ˜ å°„åˆ›å»ºæˆåŠŸ: ${Object.keys(mapping).length} ä¸ªæ˜ å°„ï¼Œæ— å†²çª`);

            // æµ‹è¯•å‰å‡ ä¸ªæ˜ å°„çš„åå‘æŸ¥æ‰¾
            console.log(`æµ‹è¯•åå‘æ˜ å°„:`);
            for (let i = 0; i < Math.min(5, base64Chars.length); i++) {
                const char = base64Chars[i];
                const combo = mapping[char];
                const reverseChar = reverseMapping[combo];
                console.log(`  "${char}" -> ${Array.from(combo).map(c => '\\u' + c.charCodeAt(0).toString(16).padStart(4, '0')).join('')} -> "${reverseChar}" ${char === reverseChar ? 'âœ“' : 'âœ—'}`);
            }

            // ç¼“å­˜æ˜ å°„è¡¨
            GLOBAL_MAPPING_CACHE = mapping;
            return mapping;
        }

        // æ··æ·†å‡½æ•°
        function starResonanceScramble(str, key, salt) {
            try {
                // 1. å°†è¾“å…¥å­—ç¬¦ä¸²ä¸ç›å€¼ç»„åˆ
                const saltedInput = str + ":" + salt;
                
                // 2. ä½¿ç”¨å¯†é’¥çš„ç‰¹å¾å€¼è¿›è¡Œé¢å¤–å¤„ç†
                let result = '';
                const keyChars = Array.from(key);
                const keySum = keyChars.reduce((sum, char) => sum + char.charCodeAt(0), 0);
                
                for (let i = 0; i < saltedInput.length; i++) {
                    const charCode = saltedInput.charCodeAt(i);
                    const keyChar = key.charCodeAt(i % key.length);
                    const xorResult = charCode ^ keyChar;
                    
                    // æ ¹æ®ä½ç½®å’Œå¯†é’¥ç‰¹å¾å€¼è¿›è¡Œåç§»
                    const offset = (i % 3 === 0) ? (keySum % 7) : ((i % 3 === 1) ? -(keySum % 5) : (keySum % 3));
                    const finalCharCode = (xorResult + offset + 65536) % 65536; // ç¡®ä¿åœ¨æœ‰æ•ˆUnicodeèŒƒå›´å†…
                    
                    result += String.fromCharCode(finalCharCode);
                }
                
                // 3. æ·»åŠ ç‰ˆæœ¬æ ‡è®°
                return VERSION + ":" + result;
            } catch (e) {
                console.error("æ··æ·†è¿‡ç¨‹ä¸­å‡ºé”™:", e);
                throw e;
            }
        }

        // è§£æ··æ·†å‡½æ•°
        function starResonanceUnscramble(scrambled, key, salt) {
            try {
                // 1. éªŒè¯å¹¶ç§»é™¤ç‰ˆæœ¬æ ‡è®°
                if (!scrambled.startsWith(VERSION + ":")) {
                    console.error("ç‰ˆæœ¬æ ‡è®°ä¸åŒ¹é…:", scrambled.substring(0, 20));
                    throw new Error("æ— æ•ˆçš„åŠ å¯†æ ¼å¼æˆ–ç‰ˆæœ¬ä¸åŒ¹é…");
                }
                
                const dataWithoutVersion = scrambled.substring(VERSION.length + 1);
                
                // 2. åå‘åº”ç”¨é¢å¤–å¤„ç†
                let result = '';
                const keyChars = Array.from(key);
                const keySum = keyChars.reduce((sum, char) => sum + char.charCodeAt(0), 0);
                
                for (let i = 0; i < dataWithoutVersion.length; i++) {
                    // åå‘åº”ç”¨é¢å¤–å¤„ç†
                    const charCode = dataWithoutVersion.charCodeAt(i);
                    const offset = (i % 3 === 0) ? (keySum % 7) : ((i % 3 === 1) ? -(keySum % 5) : (keySum % 3));
                    const unshiftedCharCode = (charCode - offset + 65536) % 65536; // ç¡®ä¿åœ¨æœ‰æ•ˆUnicodeèŒƒå›´å†…
                    
                    // XORè§£å¯†
                    const keyChar = key.charCodeAt(i % key.length);
                    const originalCharCode = unshiftedCharCode ^ keyChar;
                    
                    result += String.fromCharCode(originalCharCode);
                }
                
                // 3. ç§»é™¤ç›å€¼ - æ”¹è¿›ç‰ˆæœ¬ï¼Œæ›´å¥½åœ°å¤„ç†è¾¹ç•Œæƒ…å†µ
                const saltMarker = ":" + salt;
                const saltIndex = result.lastIndexOf(saltMarker);

                if (saltIndex === -1) {
                    console.error("æ— æ³•æ‰¾åˆ°å®Œæ•´çš„ç›å€¼æ ‡è®°ï¼Œå°è¯•å…¶ä»–æ–¹æ³•");
                    console.log("è§£æ··æ·†ç»“æœ:", result);
                    console.log("æœŸæœ›çš„ç›å€¼æ ‡è®°:", saltMarker);

                    // å°è¯•æŸ¥æ‰¾ä»»ä½•å†’å·åˆ†éš”ç¬¦
                    const lastColonIndex = result.lastIndexOf(":");
                    if (lastColonIndex !== -1) {
                        const possibleSalt = result.substring(lastColonIndex + 1);
                        console.log("æ‰¾åˆ°çš„å¯èƒ½ç›å€¼:", possibleSalt);

                        // æ£€æŸ¥æ˜¯å¦æ˜¯é¢„æœŸçš„ç›å€¼
                        if (possibleSalt === salt) {
                            console.log("æ‰¾åˆ°åŒ¹é…çš„ç›å€¼ï¼Œä½¿ç”¨å†’å·åˆ†éš”ç‚¹");
                            return result.substring(0, lastColonIndex);
                        } else {
                            console.log("ç›å€¼ä¸åŒ¹é…ï¼Œå°è¯•ç›´æ¥è¿”å›ç»“æœ");
                            // å¦‚æœç›å€¼ä¸åŒ¹é…ï¼Œå¯èƒ½æ˜¯è§£æ··æ·†è¿‡ç¨‹ä¸­çš„å­—ç¬¦ç¼–ç é—®é¢˜
                            // å°è¯•è¿”å›å»æ‰æœ€åéƒ¨åˆ†çš„ç»“æœ
                            return result.substring(0, lastColonIndex);
                        }
                    }

                    // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šæ£€æŸ¥ç»“æœæ˜¯å¦å·²ç»æ˜¯æœ‰æ•ˆçš„åŸå§‹æ¶ˆæ¯
                    console.log("æ— æ³•æ‰¾åˆ°ç›å€¼åˆ†éš”ç¬¦ï¼Œæ£€æŸ¥ç»“æœæ˜¯å¦æœ‰æ•ˆ");
                    if (result.length > salt.length + 1) {
                        // å°è¯•å»æ‰å¯èƒ½çš„ç›å€¼åç¼€
                        const withoutSuffix = result.substring(0, result.length - salt.length - 1);
                        console.log("å°è¯•å»æ‰åç¼€:", withoutSuffix);
                        return withoutSuffix;
                    }

                    throw new Error("è§£å¯†å¤±è´¥ï¼šæ— æ•ˆçš„æ•°æ®æ ¼å¼");
                }

                return result.substring(0, saltIndex);
            } catch (e) {
                console.error("è§£æ··æ·†è¿‡ç¨‹ä¸­å‡ºé”™:", e);
                throw e;
            }
        }

        // ç»Ÿä¸€çš„åŠ å¯†æ¶ˆæ¯å‡½æ•°
        function encryptMessage(message) {
            try {
                console.log(`å¼€å§‹åŠ å¯†æ¶ˆæ¯: "${message}"`);

                // 1. ç®€å•çš„å­—ç¬¦ç¼–ç ï¼Œä¸ä½¿ç”¨å¤æ‚çš„æ··æ·†
                const encoded = btoa(unescape(encodeURIComponent(message + ":" + VERSION)));
                console.log(`Base64ç¼–ç : "${encoded}" (é•¿åº¦: ${encoded.length})`);

                // 2. åˆ›å»ºBase64åˆ°é›¶å®½å­—ç¬¦çš„æ˜ å°„
                const b64ToZwMap = createBase64ToZeroWidthMap();

                // 3. å°†Base64è½¬ä¸ºé›¶å®½å­—ç¬¦
                let zeroWidthMessage = "";
                for (let i = 0; i < encoded.length; i++) {
                    const b64Char = encoded[i];
                    const zwCombo = b64ToZwMap[b64Char];
                    if (!zwCombo) {
                        console.error(`Base64å­—ç¬¦ '${b64Char}' æ²¡æœ‰å¯¹åº”çš„é›¶å®½å­—ç¬¦æ˜ å°„`);
                        throw new Error(`æ˜ å°„é”™è¯¯: å­—ç¬¦ '${b64Char}' æœªæ‰¾åˆ°æ˜ å°„`);
                    }
                    zeroWidthMessage += zwCombo;
                }
                console.log(`é›¶å®½å­—ç¬¦æ¶ˆæ¯é•¿åº¦: ${zeroWidthMessage.length}`);

                // 4. ç”Ÿæˆå–µè¯­æ–‡æœ¬
                const result = generateSimpleMeowText(zeroWidthMessage, message.length);
                console.log(`æœ€ç»ˆåŠ å¯†ç»“æœé•¿åº¦: ${result.length}`);
                return result;
            } catch (e) {
                console.error("åŠ å¯†è¿‡ç¨‹ä¸­å‡ºé”™:", e);
                throw new Error(`åŠ å¯†å¤±è´¥: ${e.message}`);
            }
        }



        // å–µè¯­æ–‡æœ¬ç”Ÿæˆå‡½æ•°
        function generateSimpleMeowText(zeroWidthMessage, originalLength) {
            // ç¡®ä¿çŸ­å¯†æ–‡ä¹Ÿæœ‰è¶³å¤Ÿçš„å¯è§å­—ç¬¦
            const result = generateVisibleTextForShortMessage(zeroWidthMessage, originalLength);

            return result + zeroWidthMessage;
        }

        // ä¸ºçŸ­æ¶ˆæ¯ç”Ÿæˆè¶³å¤Ÿçš„å¯è§å­—ç¬¦
        function generateVisibleTextForShortMessage(zeroWidthMessage, originalLength) {
            const zwLength = zeroWidthMessage.length;
            let result = "";

            // è®¡ç®—éœ€è¦çš„å¯è§å­—ç¬¦æ•°é‡
            // å¯¹äºçŸ­æ¶ˆæ¯ï¼Œç¡®ä¿è‡³å°‘æœ‰3-5ä¸ªå¯è§å­—ç¬¦
            let minVisibleChars = Math.max(3, Math.min(5, Math.ceil(originalLength / 3)));

            // å¦‚æœé›¶å®½å­—ç¬¦å¾ˆå°‘ï¼Œå¢åŠ å¯è§å­—ç¬¦æ•°é‡ä»¥ä¿æŒå¹³è¡¡
            if (zwLength < 20) {
                minVisibleChars = Math.max(minVisibleChars, 4);
            }

            // æ·»åŠ å¤šæ ·åŒ–çš„å–µè¯­è¯æ±‡
            for (let i = 0; i < minVisibleChars; i++) {
                if (i === 0) {
                    // å¼€å¤´æ€»æ˜¯ç”¨æœ€çŸ­çš„"å–µ"
                    result += PHRASES[0];
                } else {
                    // åç»­ä½¿ç”¨ä¸åŒçš„å–µè¯­è¯æ±‡å’Œæ ‡ç‚¹
                    if (i % 2 === 1 && PHRASES.length > 1) {
                        // å¥‡æ•°ä½ç½®ä½¿ç”¨å…¶ä»–å–µè¯­è¯æ±‡
                        const phraseIndex = (i - 1) % (PHRASES.length - 1) + 1;
                        result += PHRASES[phraseIndex];
                    } else {
                        // å¶æ•°ä½ç½®ä½¿ç”¨æ ‡ç‚¹ç¬¦å·
                        const punctIndex = Math.floor((i - 2) / 2) % PUNCTUATIONS.length;
                        result += PUNCTUATIONS[punctIndex];
                    }
                }
            }

            return result;
        }

        // åˆ†å—å¤„ç†å¤§æ–‡æœ¬
        function processLargeText(text, operation) {
            const chunkSize = CONFIG.CHUNK_SIZE || 1000;
            if (text.length <= chunkSize) {
                return operation(text);
            }

            const chunks = [];
            for (let i = 0; i < text.length; i += chunkSize) {
                chunks.push(text.substring(i, i + chunkSize));
            }

            console.log(`åˆ†å—å¤„ç†: ${chunks.length} ä¸ªå—ï¼Œæ¯å—æœ€å¤§ ${chunkSize} å­—ç¬¦`);

            const results = chunks.map((chunk, index) => {
                console.log(`å¤„ç†ç¬¬ ${index + 1}/${chunks.length} å—`);
                return operation(chunk);
            });

            return results.join('');
        }

        // æ£€æŸ¥æ–‡æœ¬é•¿åº¦å¹¶æ˜¾ç¤ºè­¦å‘Š
        function checkTextLength(text, warningElement, counterElement, maxLength) {
            const length = text.length;
            const warningThreshold = CONFIG.WARNING_LENGTH || 1000;

            if (counterElement) {
                if (maxLength) {
                    counterElement.textContent = `${length} / ${maxLength} å­—ç¬¦`;
                    counterElement.className = 'char-counter';
                    if (length > maxLength * 0.8) {
                        counterElement.className += ' warning';
                    }
                    if (length > maxLength * 0.95) {
                        counterElement.className += ' danger';
                    }
                } else {
                    counterElement.textContent = `${length} å­—ç¬¦`;
                }
            }

            if (warningElement) {
                if (length > warningThreshold) {
                    warningElement.style.display = 'block';
                } else {
                    warningElement.style.display = 'none';
                }
            }

            return length <= (maxLength || Infinity);
        }

        // ç»Ÿä¸€çš„è§£å¯†æ¶ˆæ¯å‡½æ•°
        function decryptMessage(encryptedMessage) {
            try {
                console.log(`å¼€å§‹è§£å¯†æ¶ˆæ¯ï¼Œé•¿åº¦: ${encryptedMessage.length}`);

                // 1. åˆ›å»ºBase64åˆ°é›¶å®½å­—ç¬¦çš„æ˜ å°„
                const b64ToZwMap = createBase64ToZeroWidthMap();

                // åˆ›å»ºåå‘æ˜ å°„
                const zwToB64Map = {};
                for (const [key, value] of Object.entries(b64ToZwMap)) {
                    zwToB64Map[value] = key;
                }

                console.log(`åå‘æ˜ å°„åˆ›å»ºå®Œæˆ: ${Object.keys(zwToB64Map).length} ä¸ªæ˜ å°„`);

                // æµ‹è¯•å‰å‡ ä¸ªåå‘æ˜ å°„
                console.log(`æµ‹è¯•åå‘æ˜ å°„:`);
                const testKeys = Object.keys(zwToB64Map).slice(0, 3);
                for (const combo of testKeys) {
                    const char = zwToB64Map[combo];
                    const comboDebug = Array.from(combo).map(c => '\\u' + c.charCodeAt(0).toString(16).padStart(4, '0')).join('');
                    console.log(`  ${comboDebug} -> "${char}"`);
                }

                // 2. æå–æ‰€æœ‰é›¶å®½å­—ç¬¦
                const zeroWidthCharsRegex = new RegExp(`[${ZERO_WIDTH_CHARS.join('')}]`, 'g');
                const zeroWidthMatches = encryptedMessage.match(zeroWidthCharsRegex) || [];
                const zeroWidthOnly = zeroWidthMatches.join('');

                console.log(`æå–åˆ° ${zeroWidthOnly.length} ä¸ªé›¶å®½å­—ç¬¦`);

                // åˆ†æå‰å‡ ä¸ªé›¶å®½å­—ç¬¦
                console.log(`å‰å‡ ä¸ªé›¶å®½å­—ç¬¦åˆ†æ:`);
                for (let i = 0; i < Math.min(9, zeroWidthOnly.length); i++) {
                    const char = zeroWidthOnly[i];
                    const code = char.charCodeAt(0).toString(16).padStart(4, '0');
                    console.log(`  [${i}] \\u${code}`);
                }

                // 3. å°†é›¶å®½å­—ç¬¦è½¬å›Base64
                let base64Message = "";
                const COMBO_LENGTH = 3; // 3ä¸ªé›¶å®½å­—ç¬¦çš„ç»„åˆ
                let unmappedCount = 0;

                for (let i = 0; i < zeroWidthOnly.length; i += COMBO_LENGTH) {
                    if (i + COMBO_LENGTH <= zeroWidthOnly.length) {
                        const zwCombo = zeroWidthOnly.substring(i, i + COMBO_LENGTH);
                        const comboDebug = Array.from(zwCombo).map(c => '\\u' + c.charCodeAt(0).toString(16).padStart(4, '0')).join('');

                        if (zwCombo in zwToB64Map) {
                            const mappedChar = zwToB64Map[zwCombo];
                            base64Message += mappedChar;

                            if (Math.floor(i / COMBO_LENGTH) < 3) {
                                console.log(`[${Math.floor(i/COMBO_LENGTH)}] ${comboDebug} -> "${mappedChar}" âœ“`);
                            }
                        } else {
                            unmappedCount++;
                            if (unmappedCount <= 3) {
                                console.warn(`[${Math.floor(i/COMBO_LENGTH)}] ${comboDebug} -> æœªæ‰¾åˆ°æ˜ å°„ âœ—`);
                            }
                            base64Message += 'A'; // é»˜è®¤å­—ç¬¦
                        }
                    }
                }

                console.log(`æ˜ å°„ç»“æœ: æˆåŠŸ ${Math.floor(zeroWidthOnly.length / COMBO_LENGTH) - unmappedCount}, å¤±è´¥ ${unmappedCount}`);

                // 4. ä¿®å¤Base64å¡«å……
                base64Message = fixBase64Padding(base64Message);

                // 5. éªŒè¯Base64æœ‰æ•ˆæ€§
                if (!isValidBase64(base64Message)) {
                    console.error("Base64å­—ç¬¦ä¸²æ— æ•ˆ:", base64Message);
                    throw new Error("è§£å¯†å¤±è´¥ï¼šæ— æ•ˆçš„Base64æ ¼å¼");
                }

                // 6. è§£ç Base64
                let decoded;
                try {
                    decoded = atob(base64Message);
                    decoded = decodeURIComponent(escape(decoded));
                } catch (e) {
                    console.error("Base64è§£ç å¤±è´¥:", e);
                    throw new Error("è§£å¯†å¤±è´¥ï¼šBase64è§£ç é”™è¯¯");
                }

                // 7. ç§»é™¤ç‰ˆæœ¬æ ‡è®°
                const versionMarker = ":" + VERSION;
                const versionIndex = decoded.lastIndexOf(versionMarker);
                if (versionIndex !== -1) {
                    return decoded.substring(0, versionIndex);
                }

                console.log("æœªæ‰¾åˆ°ç‰ˆæœ¬æ ‡è®°ï¼Œç›´æ¥è¿”å›è§£ç ç»“æœ");
                return decoded;
            } catch (e) {
                console.error("è§£å¯†é”™è¯¯è¯¦æƒ…:", e);
                throw new Error(`è§£å¯†å¤±è´¥: ${e.message}`);
            }
        }



        // ä¿®å¤Base64å¡«å……çš„è¾…åŠ©å‡½æ•°
        function fixBase64Padding(str) {
            // ç§»é™¤æ‰€æœ‰ç°æœ‰çš„å¡«å……å­—ç¬¦
            str = str.replace(/=+$/, '');

            // æ ¹æ®é•¿åº¦æ·»åŠ æ­£ç¡®çš„å¡«å……
            const remainder = str.length % 4;
            if (remainder === 2) {
                str += '==';
            } else if (remainder === 3) {
                str += '=';
            }
            // remainder === 0 æˆ– 1 æ—¶ä¸éœ€è¦å¡«å……ï¼ˆ1æ˜¯æ— æ•ˆçš„ï¼Œä½†æˆ‘ä»¬å…ˆå°è¯•å¤„ç†ï¼‰

            return str;
        }

        // æ·»åŠ è¾…åŠ©å‡½æ•°æ£€æŸ¥Base64æœ‰æ•ˆæ€§ - æ”¹è¿›ç‰ˆæœ¬
        function isValidBase64(str) {
            try {
                // æ£€æŸ¥åŸºæœ¬æ ¼å¼
                if (!str) {
                    return false;
                }

                // æ£€æŸ¥å­—ç¬¦æ˜¯å¦éƒ½æ˜¯æœ‰æ•ˆçš„Base64å­—ç¬¦
                const validChars = /^[A-Za-z0-9+/=]+$/;
                if (!validChars.test(str)) {
                    return false;
                }

                // æ£€æŸ¥é•¿åº¦æ˜¯å¦ä¸º4çš„å€æ•°
                if (str.length % 4 !== 0) {
                    return false;
                }

                // æ£€æŸ¥å¡«å……å­—ç¬¦çš„ä½ç½®æ˜¯å¦æ­£ç¡®
                const paddingMatch = str.match(/=*$/);
                if (paddingMatch) {
                    const paddingLength = paddingMatch[0].length;
                    if (paddingLength > 2) {
                        return false; // å¡«å……å­—ç¬¦ä¸èƒ½è¶…è¿‡2ä¸ª
                    }

                    // æ£€æŸ¥å¡«å……å‰çš„å­—ç¬¦æ˜¯å¦æœ‰æ•ˆ
                    const withoutPadding = str.substring(0, str.length - paddingLength);
                    if (paddingLength > 0 && withoutPadding.length % 4 !== (4 - paddingLength) % 4) {
                        return false;
                    }
                }

                // å°è¯•è§£ç 
                atob(str);
                return true;
            } catch (e) {
                return false;
            }
        }

        // æ¸…é™¤ç¼“å­˜æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('clear-cache-btn').addEventListener('click', function() {
            clearMappingCache();
            alert('æ˜ å°„ç¼“å­˜å·²æ¸…é™¤ï¼ä¸‹æ¬¡åŠ å¯†/è§£å¯†æ—¶å°†é‡æ–°åˆ›å»ºæ˜ å°„è¡¨ã€‚');
        });

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // å¦‚æœæ˜¯é…ç½®æŒ‰é’®æˆ–æ¸…é™¤ç¼“å­˜æŒ‰é’®ï¼Œä¸å¤„ç†ä¸»é¢˜åˆ‡æ¢
                if (this.id === 'config-btn-header' || this.id === 'clear-cache-btn') {
                    return;
                }

                const theme = this.getAttribute('data-theme');

                // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
                document.body.classList.remove('dark-theme', 'pink-theme', 'green-theme');

                // æ·»åŠ æ–°ä¸»é¢˜ç±»
                if (theme !== 'default') {
                    document.body.classList.add(theme + '-theme');
                }

                // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆæ’é™¤é…ç½®æŒ‰é’®å’Œæ¸…é™¤ç¼“å­˜æŒ‰é’®ï¼‰
                document.querySelectorAll('.theme-btn').forEach(b => {
                    if (b.id !== 'config-btn-header' && b.id !== 'clear-cache-btn') {
                        b.classList.remove('active');
                    }
                });
                this.classList.add('active');

                // ä¿å­˜ä¸»é¢˜è®¾ç½®
                localStorage.setItem('theme', theme);
            });
        });

        // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
        const savedTheme = localStorage.getItem('theme') || 'default';
        if (savedTheme !== 'default') {
            document.body.classList.add(savedTheme + '-theme');
        }

        // è®¾ç½®ä¸»é¢˜æŒ‰é’®çŠ¶æ€ï¼ˆæ’é™¤é…ç½®æŒ‰é’®å’Œæ¸…é™¤ç¼“å­˜æŒ‰é’®ï¼‰
        document.querySelectorAll('.theme-btn').forEach(b => {
            if (b.id !== 'config-btn-header' && b.id !== 'clear-cache-btn') {
                if (b.getAttribute('data-theme') === savedTheme) {
                    b.classList.add('active');
                } else {
                    b.classList.remove('active');
                }
            }
        });

        // ç¡®ä¿DOMå®Œå…¨åŠ è½½åå†åŠ è½½é…ç½®å’Œåˆå§‹åŒ–è°ƒè¯•é¢æ¿
        document.addEventListener('DOMContentLoaded', function() {
            clearMappingCache(); // æ¸…é™¤æ˜ å°„ç¼“å­˜ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°çš„æ˜ å°„ç®—æ³•
            loadConfig();
            initializeDebugPanel();
        });

        // é…ç½®å¯¹è¯æ¡†äº‹ä»¶ç›‘å¬å™¨
        const configModal = document.getElementById('config-modal');
        const configBtnHeader = document.getElementById('config-btn-header');
        const configClose = document.querySelector('.config-close');
        const configSave = document.getElementById('config-save');
        const configCancel = document.getElementById('config-cancel');
        const configReset = document.getElementById('config-reset');

        // æ‰“å¼€é…ç½®å¯¹è¯æ¡†
        configBtnHeader.addEventListener('click', function() {
            updateConfigUI();
            configModal.style.display = 'block';
        });

        // å…³é—­é…ç½®å¯¹è¯æ¡†
        configClose.addEventListener('click', function() {
            configModal.style.display = 'none';
        });

        configCancel.addEventListener('click', function() {
            configModal.style.display = 'none';
        });

        // ç‚¹å‡»å¯¹è¯æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(event) {
            if (event.target === configModal) {
                configModal.style.display = 'none';
            }
        });

        // ä¿å­˜é…ç½®
        configSave.addEventListener('click', function() {
            console.log('ä¿å­˜é…ç½®å‰:', CONFIG);
            const newConfig = getConfigFromUI();
            console.log('ä»UIè·å–çš„æ–°é…ç½®:', newConfig);
            CONFIG = newConfig;
            console.log('æ›´æ–°åçš„CONFIG:', CONFIG);
            saveConfig();
            configModal.style.display = 'none';
            alert('é…ç½®å·²ä¿å­˜ï¼');
        });

        // é‡ç½®é…ç½®
        configReset.addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤é…ç½®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰è®¾ç½®ã€‚')) {
                resetConfig();
                alert('é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼ï¼');
            }
        });

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        document.getElementById('encrypt-tab').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('decrypt-tab').classList.remove('active');
            document.getElementById('encrypt-panel').style.display = 'block';
            document.getElementById('decrypt-panel').style.display = 'none';
        });

        document.getElementById('decrypt-tab').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('encrypt-tab').classList.remove('active');
            document.getElementById('decrypt-panel').style.display = 'block';
            document.getElementById('encrypt-panel').style.display = 'none';
        });

        // æ–‡ä»¶ä¸‹è½½åŠŸèƒ½
        function downloadText(text, filename) {
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // åŠ å¯†æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä¼˜åŒ–ç‰ˆæœ¬
        document.getElementById('encrypt-btn').addEventListener('click', function() {
            const input = document.getElementById('encrypt-input').value;
            if (!input) {
                alert('è¯·è¾“å…¥è¦åŠ å¯†çš„æ–‡æœ¬');
                return;
            }

            // æ£€æŸ¥æ–‡æœ¬é•¿åº¦
            if (input.length > CONFIG.MAX_INPUT_LENGTH) {
                alert(`æ–‡æœ¬é•¿åº¦è¶…è¿‡é™åˆ¶ï¼ˆ${CONFIG.MAX_INPUT_LENGTH} å­—ç¬¦ï¼‰ï¼Œè¯·ç¼©çŸ­æ–‡æœ¬æˆ–åˆ†æ®µå¤„ç†`);
                return;
            }

            // æ˜¾ç¤ºå¤„ç†çŠ¶æ€
            const btn = this;
            const originalText = btn.textContent;
            btn.textContent = 'åŠ å¯†ä¸­...';
            btn.disabled = true;

            // ä½¿ç”¨ setTimeout è®©UIæœ‰æ—¶é—´æ›´æ–°
            setTimeout(() => {
                try {
                    const startTime = performance.now();
                    let encrypted;

                    if (input.length > CONFIG.CHUNK_SIZE) {
                        encrypted = processLargeText(input, encryptMessage);
                    } else {
                        encrypted = encryptMessage(input);
                    }

                    const endTime = performance.now();
                    const processingTime = (endTime - startTime).toFixed(2);

                    // æ˜¾ç¤ºç»“æœ
                    const outputElement = document.getElementById('encrypt-output');
                    const statsElement = document.getElementById('encrypt-stats');

                    // é™åˆ¶æ˜¾ç¤ºé•¿åº¦ï¼Œé¿å…é¡µé¢å¡é¡¿
                    const maxDisplayLength = 1000;
                    if (encrypted.length > maxDisplayLength) {
                        outputElement.textContent = encrypted.substring(0, maxDisplayLength) + '\n\n... (ç»“æœè¿‡é•¿ï¼Œå·²æˆªæ–­æ˜¾ç¤ºï¼Œè¯·ä½¿ç”¨å¤åˆ¶æˆ–ä¸‹è½½åŠŸèƒ½è·å–å®Œæ•´ç»“æœ)';
                    } else {
                        outputElement.textContent = encrypted;
                    }

                    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    const compressionRatio = (encrypted.length / input.length).toFixed(2);
                    const fileSize = formatFileSize(new Blob([encrypted]).size);
                    statsElement.textContent = `é•¿åº¦: ${encrypted.length} å­—ç¬¦ | å‹ç¼©æ¯”: ${compressionRatio}:1 | å¤§å°: ${fileSize} | è€—æ—¶: ${processingTime}ms`;

                    document.getElementById('encrypt-result').style.display = 'block';

                    // å­˜å‚¨å®Œæ•´ç»“æœç”¨äºå¤åˆ¶å’Œä¸‹è½½
                    window.lastEncryptResult = encrypted;

                } catch (e) {
                    alert(`åŠ å¯†å¤±è´¥: ${e.message}`);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            }, 10);
        });

        // è§£å¯†æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä¼˜åŒ–ç‰ˆæœ¬
        document.getElementById('decrypt-btn').addEventListener('click', function() {
            const input = document.getElementById('decrypt-input').value;
            if (!input) {
                alert('è¯·è¾“å…¥è¦è§£å¯†çš„æ–‡æœ¬');
                return;
            }

            // æ˜¾ç¤ºå¤„ç†çŠ¶æ€
            const btn = this;
            const originalText = btn.textContent;
            btn.textContent = 'è§£å¯†ä¸­...';
            btn.disabled = true;

            // ä½¿ç”¨ setTimeout è®©UIæœ‰æ—¶é—´æ›´æ–°
            setTimeout(() => {
                try {
                    const startTime = performance.now();
                    const decrypted = decryptMessage(input);
                    const endTime = performance.now();
                    const processingTime = (endTime - startTime).toFixed(2);

                    // æ˜¾ç¤ºç»“æœ
                    const outputElement = document.getElementById('decrypt-output');
                    const statsElement = document.getElementById('decrypt-stats');

                    // é™åˆ¶æ˜¾ç¤ºé•¿åº¦ï¼Œé¿å…é¡µé¢å¡é¡¿
                    const maxDisplayLength = 1000;
                    if (decrypted.length > maxDisplayLength) {
                        outputElement.textContent = decrypted.substring(0, maxDisplayLength) + '\n\n... (ç»“æœè¿‡é•¿ï¼Œå·²æˆªæ–­æ˜¾ç¤ºï¼Œè¯·ä½¿ç”¨å¤åˆ¶æˆ–ä¸‹è½½åŠŸèƒ½è·å–å®Œæ•´ç»“æœ)';
                    } else {
                        outputElement.textContent = decrypted;
                    }

                    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    const fileSize = formatFileSize(new Blob([decrypted]).size);
                    statsElement.textContent = `é•¿åº¦: ${decrypted.length} å­—ç¬¦ | å¤§å°: ${fileSize} | è€—æ—¶: ${processingTime}ms`;

                    document.getElementById('decrypt-result').style.display = 'block';

                    // å­˜å‚¨å®Œæ•´ç»“æœç”¨äºå¤åˆ¶å’Œä¸‹è½½
                    window.lastDecryptResult = decrypted;

                } catch (e) {
                    alert(`è§£å¯†å¤±è´¥: ${e.message}`);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            }, 10);
        });

        // å¤åˆ¶åŠ å¯†ç»“æœ - ä½¿ç”¨å®Œæ•´ç»“æœ
        document.getElementById('copy-encrypt').addEventListener('click', function() {
            const text = window.lastEncryptResult || document.getElementById('encrypt-output').textContent;
            navigator.clipboard.writeText(text).then(function() {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }, function() {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        });

        // å¤åˆ¶è§£å¯†ç»“æœ - ä½¿ç”¨å®Œæ•´ç»“æœ
        document.getElementById('copy-decrypt').addEventListener('click', function() {
            const text = window.lastDecryptResult || document.getElementById('decrypt-output').textContent;
            navigator.clipboard.writeText(text).then(function() {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }, function() {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        });

        // ä¸‹è½½åŠ å¯†ç»“æœ
        document.getElementById('download-encrypt').addEventListener('click', function() {
            const text = window.lastEncryptResult || document.getElementById('encrypt-output').textContent;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            downloadText(text, `encrypted_${timestamp}.txt`);
        });

        // ä¸‹è½½è§£å¯†ç»“æœ
        document.getElementById('download-decrypt').addEventListener('click', function() {
            const text = window.lastDecryptResult || document.getElementById('decrypt-output').textContent;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            downloadText(text, `decrypted_${timestamp}.txt`);
        });

        // è¾“å…¥æ¡†å­—ç¬¦è®¡æ•°å’Œè­¦å‘Š
        document.getElementById('encrypt-input').addEventListener('input', function() {
            checkTextLength(
                this.value,
                document.getElementById('encrypt-warning'),
                document.getElementById('encrypt-counter'),
                CONFIG.MAX_INPUT_LENGTH
            );
        });

        document.getElementById('decrypt-input').addEventListener('input', function() {
            checkTextLength(
                this.value,
                document.getElementById('decrypt-warning'),
                document.getElementById('decrypt-counter')
            );
        });

        // åˆå§‹åŒ–è°ƒè¯•é¢æ¿
        function initializeDebugPanel() {
            // æ·»åŠ è°ƒè¯•æŒ‰é’®å’Œé¢æ¿
            const container = document.querySelector('.container');
            if (container && !document.getElementById('debug-btn')) {
                container.insertAdjacentHTML('beforeend', `
                    <div class="debug-panel">
                        <h3>è°ƒè¯•å·¥å…·</h3>
                        <div class="debug-controls">
                            <button id="debug-btn">ç³»ç»Ÿè°ƒè¯•</button>
                            <button id="test-mapping-btn">æ˜ å°„æµ‹è¯•</button>
                            <button id="test-full-btn">å®Œæ•´æµ‹è¯•</button>
                            <button id="clear-debug-btn">æ¸…é™¤ç»“æœ</button>
                        </div>

                        <div id="debug-results" style="margin-top: 15px;">
                            <div id="system-debug" class="debug-section" style="display: none;">
                                <h4>ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯</h4>
                                <pre id="system-debug-content"></pre>
                            </div>

                            <div id="mapping-test" class="debug-section" style="display: none;">
                                <h4>æ˜ å°„æµ‹è¯•ç»“æœ</h4>
                                <div id="mapping-test-status"></div>
                                <pre id="mapping-test-content"></pre>
                            </div>

                            <div id="full-test" class="debug-section" style="display: none;">
                                <h4>å®Œæ•´åŠ å¯†è§£å¯†æµ‹è¯•</h4>
                                <div id="full-test-status"></div>
                                <pre id="full-test-content"></pre>
                            </div>
                        </div>
                    </div>
                `);

                // æ¸…é™¤è°ƒè¯•ç»“æœæŒ‰é’®
                document.getElementById('clear-debug-btn').addEventListener('click', function() {
                    document.getElementById('system-debug').style.display = 'none';
                    document.getElementById('mapping-test').style.display = 'none';
                    document.getElementById('full-test').style.display = 'none';
                });

                // æµ‹è¯•æ˜ å°„æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                document.getElementById('test-mapping-btn').addEventListener('click', function() {
                    const section = document.getElementById('mapping-test');
                    const status = document.getElementById('mapping-test-status');
                    const content = document.getElementById('mapping-test-content');

                    section.style.display = 'block';
                    status.innerHTML = 'æ­£åœ¨æµ‹è¯•...';
                    content.textContent = '';

                    // é‡å®šå‘console.logåˆ°è°ƒè¯•é¢æ¿
                    const originalLog = console.log;
                    const logs = [];
                    console.log = function(...args) {
                        logs.push(args.join(' '));
                        originalLog.apply(console, args);
                    };

                    try {
                        const result = testMapping();
                        status.innerHTML = `<span class="${result ? 'status-success' : 'status-error'}">${result ? 'âœ… æµ‹è¯•é€šè¿‡' : 'âŒ æµ‹è¯•å¤±è´¥'}</span>`;
                        content.textContent = logs.join('\n');
                    } catch (e) {
                        status.innerHTML = `<span class="status-error">âŒ æµ‹è¯•å‡ºé”™: ${e.message}</span>`;
                    } finally {
                        console.log = originalLog;
                    }
                });

                // å®Œæ•´æµ‹è¯•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                document.getElementById('test-full-btn').addEventListener('click', function() {
                    const section = document.getElementById('full-test');
                    const status = document.getElementById('full-test-status');
                    const content = document.getElementById('full-test-content');

                    section.style.display = 'block';
                    status.innerHTML = 'æ­£åœ¨æµ‹è¯•...';
                    content.textContent = '';

                    // é‡å®šå‘console.logåˆ°è°ƒè¯•é¢æ¿
                    const originalLog = console.log;
                    const originalError = console.error;
                    const logs = [];
                    console.log = function(...args) {
                        logs.push(args.join(' '));
                        originalLog.apply(console, args);
                    };
                    console.error = function(...args) {
                        logs.push('ERROR: ' + args.join(' '));
                        originalError.apply(console, args);
                    };

                    try {
                        const result = testFullEncryptDecrypt();
                        status.innerHTML = `<span class="${result ? 'status-success' : 'status-error'}">${result ? 'âœ… æµ‹è¯•é€šè¿‡' : 'âŒ æµ‹è¯•å¤±è´¥'}</span>`;
                        content.textContent = logs.join('\n');
                    } catch (e) {
                        status.innerHTML = `<span class="status-error">âŒ æµ‹è¯•å‡ºé”™: ${e.message}</span>`;
                    } finally {
                        console.log = originalLog;
                        console.error = originalError;
                    }
                });

                // ç³»ç»Ÿè°ƒè¯•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                document.getElementById('debug-btn').addEventListener('click', async function() {
                    const section = document.getElementById('system-debug');
                    const content = document.getElementById('system-debug-content');

                    section.style.display = 'block';
                    // æ”¶é›†ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯
                    let info = "";

                    // 1. æ˜¾ç¤ºå…³é”®å‚æ•°
                    info += "=== ç³»ç»Ÿé…ç½® ===\n";
                    info += `VERSION: ${CONFIG.VERSION}\n`;
                    info += `KEY: ${CONFIG.KEY.substring(0, 10)}...\n`;
                    info += `SALT: ${CONFIG.SALT.substring(0, 10)}...\n`;
                    info += `PHRASES: [${CONFIG.PHRASES.join(', ')}]\n`;
                    info += `PUNCTUATIONS: [${CONFIG.PUNCTUATIONS.join(', ')}]\n\n`;

                    // 2. é›¶å®½å­—ç¬¦ä¿¡æ¯
                    info += "=== é›¶å®½å­—ç¬¦é…ç½® ===\n";
                    info += `é›¶å®½å­—ç¬¦æ•°é‡: ${ZERO_WIDTH_CHARS.length}\n`;
                    info += `é›¶å®½å­—ç¬¦åˆ—è¡¨:\n`;
                    ZERO_WIDTH_CHARS.forEach((char, index) => {
                        const code = char.charCodeAt(0).toString(16).padStart(4, '0');
                        info += `  [${index}] \\u${code}\n`;
                    });
                    info += `\n`;

                    // 3. æ˜ å°„è¡¨çŠ¶æ€
                    info += "=== æ˜ å°„è¡¨çŠ¶æ€ ===\n";
                    info += `æ˜ å°„ç¼“å­˜çŠ¶æ€: ${GLOBAL_MAPPING_CACHE ? 'å·²ç¼“å­˜' : 'æœªç¼“å­˜'}\n`;
                    if (GLOBAL_MAPPING_CACHE) {
                        info += `æ˜ å°„æ•°é‡: ${Object.keys(GLOBAL_MAPPING_CACHE).length}\n`;
                    }

                    content.textContent = info;
                });
            }
        }
    </script>
</body>
</html>